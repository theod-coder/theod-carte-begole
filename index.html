<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BÃ©gole Map ğŸŒ³</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2ecc71">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BÃ©gole Map">
    <link rel="apple-touch-icon" href="logo/logoV2.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="weather-overlay"></div>
    <div id="firefly-overlay"></div>
    <div id="cloud-overlay"></div>
    <div id="pollen-overlay"></div>
    <div id="map"></div>

    <button id="btn-compass">ğŸ§­</button>
    <button id="btn-recenter" class="hidden">ğŸ¯ Recentrer</button>
    
    <div id="dashboard" class="hidden">
        <div class="dash-item"><span class="dash-val" id="dash-alt">--</span><span class="dash-unit">m</span><span class="dash-label">Alt</span></div>
        <div style="width:1px; background:rgba(0,0,0,0.1);"></div>
        <div class="dash-item"><span class="dash-val" id="dash-speed">0</span><span class="dash-unit">km/h</span><span class="dash-label">Vit</span></div>
        <div style="width:1px; background:rgba(0,0,0,0.1);"></div>
        <div class="dash-item"><span class="dash-val" id="dash-dist">0.00</span><span class="dash-unit">km</span><span class="dash-label">Dist</span></div>
    </div>

    <div id="recording-container" class="hidden">
        <div id="recording-indicator">REC â—</div>
        <div id="recording-timer">00:00</div>
    </div>

    <div id="toast-container"></div>

    <div id="pocket-overlay" class="hidden-poche">
        <div style="font-size:40px; margin-bottom:20px;">ğŸ”’</div>
        <div>Mode Poche ActivÃ©</div>
        <small>(Tapoter pour dÃ©verrouiller)</small>
        <button class="pocket-btn" id="btn-pocket-unlock">DÃ©verrouiller</button>
    </div>

    <div id="replay-controls" class="hidden">
        <button id="btn-replay-stop" class="btn-stop-track" style="padding:10px 20px;">ArrÃªter le Replay â¹ï¸</button>
    </div>

    <div id="menu-container">
        <button id="menu-toggle">â˜° Menu</button>
        
        <div id="menu-items" class="hidden-mobile">
            
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <div class="astro-widget" style="flex:1; margin:0;">
                    <span id="astro-sun">â˜€ï¸ --h--</span>
                    <span id="astro-moon">ğŸŒ‘ --%</span>
                </div>
                <div class="weather-widget" id="weather-widget-btn" style="flex:1; margin:0;">
                    <div class="env-row" style="margin:0;">
                        <div id="weather-desc" style="font-size:12px;">--</div>
                        <div id="weather-temp">--Â°C</div>
                    </div>
                </div>
            </div>

            <div id="achievements-trigger" style="background:rgba(0,0,0,0.03); padding:5px 10px; border-radius:10px; margin-bottom:15px; cursor:pointer;">
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <span id="user-title" style="font-weight:800; color:#e67e22; font-size:12px;">Vagabond</span>
                    <span id="user-lvl" style="font-size:10px; font-weight:bold; color:#888;">Niv. 1</span>
                </div>
                <div style="background:#ddd; height:4px; border-radius:2px; overflow:hidden; margin-top:2px;">
                    <div id="user-xp-bar" style="width:0%; height:100%; background:#2ecc71;"></div>
                </div>
            </div>

            <div class="menu-section-title">ğŸš€ Actions Rapides</div>
            
            <button id="btn-tracking" class="btn-start-track" style="margin-bottom:5px; justify-content:center; text-align:center;">â–¶ï¸ Lancer Trajet</button>

            <button id="btn-pocket-mode" style="width:100%; margin-bottom:10px; background:#2c3e50; color:white; border:none; padding:10px; border-radius:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
                ğŸ”’ Mode Poche
            </button>

            <button id="btn-fullscreen" style="width:100%; margin-bottom:10px; background:#34495e; color:white; border:none; padding:10px; border-radius:12px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
                â›¶ Plein Ã‰cran
            </button>

            <div class="tools-grid">
                <button id="btn-plantnet" class="btn-grid" style="background:#27ae60;">
                    <span class="grid-icon">ğŸŒ¿</span><span class="grid-text">Identifier<br>Plante</span>
                </button>
                <button id="btn-pisteur" class="btn-grid" style="background:#795548;">
                    <span class="grid-icon">ğŸ¾</span><span class="grid-text">Guide<br>Pisteur</span>
                </button>
            </div>

            <div class="menu-section-title">ğŸ—ºï¸ Carte & Filtres</div>
            
            <div class="toggles-container">
                <div class="toggle-row">
                    <span>ğŸ  Limites Cadastre</span>
                    <label class="switch"><input type="checkbox" id="cadastre-mode-toggle"><span class="slider round"></span></label>
                </div>
                
                <div id="cadastre-opacity-container" class="hidden" style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;">
                    <span style="font-size:10px; color:#888;">OpacitÃ©</span>
                    <input type="range" id="cadastre-opacity-input" min="0" max="1" step="0.1" value="0.5" style="width:100%;">
                </div>

                <div class="toggle-row">
                    <span>ğŸ’¾ Voir Parcelles SauvÃ©es</span>
                    <label class="switch"><input type="checkbox" id="show-parcels-toggle"><span class="slider round"></span></label>
                </div>
                <div class="toggle-row"><span>ğŸ”¥ Heatmap</span><label class="switch"><input type="checkbox" id="heatmap-toggle"><span class="slider round"></span></label></div>
                <div class="toggle-row"><span>ğŸ“¡ Radar (40m)</span><label class="switch"><input type="checkbox" id="radar-toggle"><span class="slider round"></span></label></div>
                <div class="toggle-row"><span style="color:#3498db; font-weight:bold;">ğŸŒ‘ Nuit Profonde</span><label class="switch"><input type="checkbox" id="deep-night-toggle"><span class="slider round"></span></label></div>
                <div class="toggle-row"><span style="color:#c0392b; font-weight:bold;">ğŸ™ˆ Mode Secret</span><label class="switch"><input type="checkbox" id="intruder-toggle"><span class="slider round"></span></label></div>
                <div class="toggle-row">
                    <span>ğŸš© Limites Village</span>
                    <label class="switch"><input type="checkbox" id="borders-toggle" checked><span class="slider round"></span></label>
                </div>
            </div>

            <div class="filter-row" style="margin-top:10px;">
                <input type="text" id="filter-input" placeholder="ğŸ„" maxlength="2">
                <input type="text" id="text-filter-input" placeholder="Recherche..." style="flex:1;">
                <button id="btn-filter-ok" class="btn-filter-ok" style="flex:0;">OK</button>
            </div>
            
            <div class="filter-row" style="margin-top:5px;">
                <select id="filter-year" class="year-select" style="margin:0; flex:1;">
                    <option value="all">AnnÃ©e</option>
                </select>
                <select id="filter-month" class="year-select" style="margin:0; flex:1;">
                    <option value="all">Mois</option>
                    <option value="1">Jan</option><option value="2">FÃ©v</option><option value="3">Mar</option>
                    <option value="4">Avr</option><option value="5">Mai</option><option value="6">Juin</option>
                    <option value="7">Juil</option><option value="8">AoÃ»t</option><option value="9">Sep</option>
                    <option value="10">Oct</option><option value="11">Nov</option><option value="12">DÃ©c</option>
                </select>
            </div>

            <div class="filter-row" style="margin-top:5px;">
                <button id="btn-loc" class="btn-loc" style="flex:1; font-size:12px;">ğŸ“ Position</button>
                <button id="btn-filter-reset" class="btn-filter-reset" style="flex:1; font-size:12px;">Tout voir</button>
            </div>

            <div class="menu-section-title">âœ¨ Immersion</div>
            
            <div class="avatar-selector">
                <div class="avatar-option" id="av-man">ğŸš¶</div>
                <div class="avatar-option" id="av-boar">ğŸ—</div>
                <div class="avatar-option" id="av-deer">ğŸ¦Œ</div>
                <div class="avatar-option" id="av-bird">ğŸ¦…</div>
            </div>

            <div class="tools-grid">
                <button id="btn-sound" class="btn-grid" style="background:#34495e;">
                    <span class="grid-icon">ğŸ”‡</span><span class="grid-text">Son</span>
                </button>
                <div class="btn-grid" style="background:#95a5a6; cursor:default; padding:5px;">
                    <span style="font-size:24px; display:block;">â˜ï¸</span>
                    <span class="grid-text" style="margin-bottom:5px;">Nuages</span>
                    <label class="switch"><input type="checkbox" id="clouds-toggle"><span class="slider round"></span></label>
                </div>
            </div>

            <div class="menu-section-title">ğŸ’¾ SystÃ¨me & DonnÃ©es</div>
            
            <button class="btn-history" id="btn-open-history" style="margin-bottom:5px;">ğŸ“œ Historique Trajets</button>
            
            <div class="filter-row">
                <button id="btn-show-stats" class="btn-stats" style="flex:1;">ğŸ† Globales</button>
                <button id="btn-show-cadastre-stats" class="btn-stats" style="flex:1; background:#e67e22;">ğŸ“Š Cadastre</button>
            </div>
            
            <div class="storage-container" style="margin-top:10px;">
                <div class="storage-header"><span id="storage-text">Stockage...</span></div>
                <div class="storage-track"><div class="storage-fill" id="storage-bar" style="width:0%"></div></div>
            </div>

            <div class="filter-row">
                <button id="btn-export" class="btn-save">Sauver</button>
                <label class="btn-load" style="flex:1; text-align:center; display:block; padding:12px; border-radius:12px; color:white; font-weight:bold; cursor:pointer;">
                    Charger <input type="file" id="import-file" style="display:none;">
                </label>
            </div>
            
            <button id="btn-reset-data" class="btn-danger" style="margin-top:10px; font-size:10px; padding:5px;">âš ï¸ Reset Total</button>
            
            <div style="text-align:center; margin-top:15px; font-size:9px; color:#aaa;">
                BÃ©gole Map v4.0 (Organized)
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden">
        <div class="modal-box">
            <h3>Nouveau Point</h3>
            <div style="padding:20px;">
                <div id="point-env-info" style="font-size:11px; color:#8e44ad; margin-bottom:10px; text-align:center;"></div>
                <label>IcÃ´ne (Emoji)</label>
                <input type="text" id="input-emoji" value="ğŸ“" style="text-align:center; font-size:24px;">
                <label>Note / Description</label>
                <textarea id="input-note" placeholder="Ex: CÃ¨pes, Belle vue..."></textarea>
            </div>
            <div class="modal-buttons">
                <button id="btn-modal-point-cancel" class="btn-cancel">Annuler</button>
                <button id="btn-modal-point-confirm" class="btn-confirm">Valider</button>
            </div>
        </div>
    </div>

    <div id="history-overlay" class="hidden">
        <div class="modal-box" style="max-height:90vh;">
            <h3>Mes Trajets</h3>
            <div style="padding:10px; background:#f9f9f9; border-bottom:1px solid #eee;">
                <select id="filter-trip-class" class="year-select" style="margin:0;">
                    <option value="all">Tout voir</option>
                    <option value="blue">ğŸ”µ Balades (<2km)</option>
                    <option value="green">ğŸŸ¢ Randos (2-5km)</option>
                    <option value="orange">ğŸŸ  Grosses Randos (5-10km)</option>
                    <option value="red">ğŸ”´ ExpÃ©ditions (>10km)</option>
                </select>
            </div>
            <div id="tripList" class="scrollable-content"></div>
            <button id="btn-history-close" style="margin:10px; background:#34495e; color:white; padding:10px; border:none; border-radius:10px;">Fermer</button>
        </div>
    </div>

    <div id="modal-edit-point" class="hidden">
        <div class="modal-box">
            <h3>Carnet de Bord</h3>
            <div class="scrollable-content">
                <div id="history-env-info" style="font-size:11px; color:#8e44ad; margin-bottom:5px; text-align:center;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="edit-emoji" style="width:50px; text-align:center; font-size:20px;">
                    <input type="text" id="edit-note" style="flex:1;">
                </div>
                <hr style="margin:10px 0; border:0; border-top:1px dashed #ccc;">
                <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">ğŸ“– Historique du lieu :</div>
                <div id="history-list-container" class="history-list"></div>
                <div class="history-add-container">
                    <textarea id="new-history-entry" placeholder="Ajouter une note aujourd'hui..." style="height:50px; font-size:12px;"></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                        <label class="btn-photo-label">
                            ğŸ“· Photo <input type="file" id="history-photo-input" accept="image/*" style="display:none;">
                        </label>
                        <span id="photo-status" style="font-size:10px; color:#27ae60; display:none;">Image OK</span>
                        <button id="btn-add-history" class="btn-add-history">Ajouter +</button>
                    </div>
                </div>
            </div>
            <div class="modal-buttons" style="flex-wrap:wrap;">
                <button id="btn-edit-point-save" class="btn-confirm" style="flex:2;">Enregistrer</button>
                <button id="btn-edit-point-delete" class="btn-danger" style="flex:1;">Suppr.</button>
            </div>
        </div>
    </div>
    
    <div id="lightbox-overlay" class="hidden">
        <img id="lightbox-img" src="">
    </div>

    <div id="modal-cadastre-stats" class="hidden">
        <div class="modal-box">
            <h3 style="background:#e67e22;">PropriÃ©tÃ©s</h3>
            <div id="cadastre-stats-content" class="scrollable-content"></div>
            <button id="btn-cadastre-stats-close" class="btn-cancel" style="margin:10px;">Fermer</button>
        </div>
    </div>
    
    <div id="modal-parcel" class="hidden">
        <div class="modal-box">
            <h3 style="background:#34495e;">Parcelle</h3>
            <div style="padding:20px; text-align:center;">
                <div id="parcel-ref" style="font-weight:bold; font-size:18px; margin-bottom:5px;"></div>
                <div id="parcel-area" style="font-size:14px; color:#666; margin-bottom:15px;"></div>
                <label>Couleur de marquage</label>
                <div class="color-picker-row">
                    <div class="color-option selected" style="background:#95a5a6;" data-color="#95a5a6"></div>
                    <div class="color-option" style="background:#2ecc71;" data-color="#2ecc71"></div>
                    <div class="color-option" style="background:#e74c3c;" data-color="#e74c3c"></div>
                    <div class="color-option" style="background:#f1c40f;" data-color="#f1c40f"></div>
                    <div class="color-option" style="background:#3498db;" data-color="#3498db"></div>
                </div>
                <label>Note propriÃ©taire</label>
                <input type="text" id="parcel-note" placeholder="Nom, statut...">
            </div>
            <div class="modal-buttons">
                <button id="btn-parcel-close" class="btn-cancel">Fermer</button>
                <button id="btn-parcel-save" class="btn-confirm">Sauvegarder</button>
            </div>
        </div>
    </div>

    <div id="modal-edit-trip" class="hidden">
        <div class="modal-box">
            <h3>Modifier Trajet</h3>
            <div style="padding:20px;">
                <label>Note sur le trajet</label>
                <textarea id="edit-trip-note" placeholder="Ex: Difficile, vu un renard..."></textarea>
            </div>
            <div class="modal-buttons">
                <button id="btn-edit-trip-close" class="btn-cancel">Annuler</button>
                <button id="btn-edit-trip-save" class="btn-confirm">Sauver</button>
            </div>
        </div>
    </div>

    <div id="modal-elevation" class="hidden">
        <div class="modal-box" style="width:95%; max-width:500px;">
            <h3 style="background:#27ae60;">DÃ©nivelÃ©</h3>
            <div style="padding:10px; background:white;">
                <canvas id="elevation-canvas" width="300" height="150" style="width:100%; height:150px;"></canvas>
                <div style="display:flex; justify-content:space-between; font-size:10px; color:#666; margin-top:5px;">
                    <span id="elev-min">Min: --</span>
                    <span id="elev-max">Max: --</span>
                </div>
            </div>
            <button id="btn-elevation-close" class="btn-cancel" style="margin:10px;">Fermer</button>
        </div>
    </div>

    <div id="stats-overlay" class="hidden">
        <div class="modal-box">
            <h3 style="background:#f1c40f; color:#333;">Statistiques</h3>
            <div id="stats-content" class="scrollable-content"></div>
            <button id="btn-stats-close" class="btn-cancel" style="margin:10px;">Fermer</button>
        </div>
    </div>

    <div id="modal-achievements" class="hidden">
        <div class="modal-box">
            <h3 style="background:#9b59b6;">SuccÃ¨s & Badges</h3>
            <div id="achievements-content" class="scrollable-content" style="background:#f4f6f7;"></div>
            <button id="btn-achievements-close" class="btn-cancel" style="margin:10px;">Fermer</button>
        </div>
    </div>

    <div id="modal-plantnet" class="hidden">
        <div class="modal-box">
            <h3 style="background:#27ae60;">Identifier une Plante</h3>
            <div class="scrollable-content">
                <div id="plantnet-upload-area" style="text-align:center; padding:20px;">
                    <div style="font-size:50px; margin-bottom:10px;">ğŸ“¸</div>
                    <p>Prends une photo claire de la feuille ou de la fleur.</p>
                    <label>C'est quoi ?</label>
                    <select id="plant-organ" style="margin-bottom:15px;">
                        <option value="leaf">ğŸƒ Feuille</option>
                        <option value="flower">ğŸŒ¸ Fleur</option>
                        <option value="fruit">ğŸ Fruit</option>
                        <option value="bark">ğŸªµ Ã‰corce</option>
                        <option value="auto">ğŸ¤– Auto</option>
                    </select>
                    <label class="btn-load" style="background:#27ae60; display:block; padding:15px;">
                        Prendre Photo
                        <input type="file" id="plantnet-file-input" accept="image/*" capture="environment" style="display:none;">
                    </label>
                </div>
                <div id="plantnet-loading" class="hidden" style="text-align:center; padding:40px;">
                    <div style="font-size:30px; animation:spin 1s infinite linear;">ğŸ”„</div>
                    <p>Analyse IA en cours...</p>
                </div>
                <div id="plantnet-results" class="hidden"></div>
            </div>
            <button id="btn-plantnet-close" class="btn-cancel" style="margin:10px;">Fermer</button>
        </div>
    </div>

    <div id="modal-pisteur" class="hidden">
        <div class="modal-box">
            <h3 style="background:#795548;">Guide du Pisteur</h3>
            <div id="pisteur-grid" class="achievements-grid" style="padding:10px;"></div>
            <button id="btn-pisteur-close" class="btn-cancel" style="margin:10px;">Fermer</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    
    <script type="module" src="js/main.js"></script>
</body>
</html>